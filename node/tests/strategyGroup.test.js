const path = require('path');
if (!global.xreq) {
  global.xreq = function(m) {
      return require(path.resolve(__dirname, '..', m));
  }
}

const assert = require('assert');
const sinon = require('sinon');
const {strategyFac} = require('../background/strategyController');
const {feng} = require('../background/feng.js');
const {accld, NormalAccount} = require('../background/accounts.js');
const {alarmHub} = require('../background/klineTimer.js');
const {klPad, KLine} = require('../background/kline.js');

if (require.main === module) {
  const Mocha = require('mocha');
  const mocha = new Mocha();
  mocha.addFile(__filename);
  mocha.run(failures => {
    process.exitCode = failures ? 1 : 0;
  });
  return;
}

describe('check Strategy', () => {
  let loadWatchingsStub;
  let fengGetsecidStub;
  let getStockKlineStub;

  beforeEach(() => {
    loadWatchingsStub = sinon.stub(NormalAccount.prototype, 'loadWatchings')
      .resolves(Promise.resolve());
    fengGetsecidStub = sinon.stub(feng, 'getStockSecId').callsFake(async(code)=>{
        return code;
    });
    getStockKlineStub = sinon.stub(feng, 'getStockKline').callsFake( async(code, klt, date) => {
        let kdata = [];
        if (klt == 15 && code == '512100') {
          kdata = [{"time":"2025-04-11 09:45","o":"2.297","c":"2.316","h":"2.326","l":"2.295","v":"1148196","prc":"0.003","pc":"0.13"},{"time":"2025-04-11 10:00","o":"2.317","c":"2.331","h":"2.333","l":"2.317","v":"353240","prc":"0.015","pc":"0.65"},{"time":"2025-04-11 10:15","o":"2.331","c":"2.323","h":"2.331","l":"2.321","v":"258139","prc":"-0.008","pc":"-0.34"},{"time":"2025-04-11 10:30","o":"2.322","c":"2.326","h":"2.331","l":"2.317","v":"323237","prc":"0.003","pc":"0.13"},{"time":"2025-04-11 10:45","o":"2.325","c":"2.328","h":"2.331","l":"2.324","v":"233781","prc":"0.002","pc":"0.09"},{"time":"2025-04-11 11:00","o":"2.328","c":"2.319","h":"2.328","l":"2.319","v":"137031","prc":"-0.009","pc":"-0.39"},{"time":"2025-04-11 11:15","o":"2.319","c":"2.330","h":"2.330","l":"2.318","v":"182217","prc":"0.011","pc":"0.47"},{"time":"2025-04-11 11:30","o":"2.330","c":"2.335","h":"2.336","l":"2.327","v":"210876","prc":"0.005","pc":"0.21"},{"time":"2025-04-11 13:15","o":"2.340","c":"2.352","h":"2.362","l":"2.336","v":"688654","prc":"0.017","pc":"0.73"},{"time":"2025-04-11 13:30","o":"2.352","c":"2.353","h":"2.356","l":"2.345","v":"191598","prc":"0.001","pc":"0.04"},{"time":"2025-04-11 13:45","o":"2.352","c":"2.367","h":"2.367","l":"2.349","v":"415330","prc":"0.014","pc":"0.59"},{"time":"2025-04-11 14:00","o":"2.367","c":"2.361","h":"2.372","l":"2.357","v":"432831","prc":"-0.006","pc":"-0.25"},{"time":"2025-04-11 14:15","o":"2.361","c":"2.352","h":"2.364","l":"2.352","v":"198353","prc":"-0.009","pc":"-0.38"},{"time":"2025-04-11 14:30","o":"2.352","c":"2.349","h":"2.357","l":"2.348","v":"136581","prc":"-0.003","pc":"-0.13"},{"time":"2025-04-11 14:45","o":"2.350","c":"2.344","h":"2.353","l":"2.338","v":"266689","prc":"-0.005","pc":"-0.21"},{"time":"2025-04-11 15:00","o":"2.344","c":"2.343","h":"2.348","l":"2.341","v":"724573","prc":"-0.001","pc":"-0.04"},{"time":"2025-04-14 09:45","o":"2.366","c":"2.369","h":"2.381","l":"2.362","v":"1381985","prc":"0.026","pc":"1.11"},{"time":"2025-04-14 10:00","o":"2.368","c":"2.372","h":"2.378","l":"2.366","v":"1039062","prc":"0.003","pc":"0.13"},{"time":"2025-04-14 10:15","o":"2.372","c":"2.381","h":"2.383","l":"2.367","v":"699318","prc":"0.009","pc":"0.38"},{"time":"2025-04-14 10:30","o":"2.381","c":"2.378","h":"2.382","l":"2.376","v":"437906","prc":"-0.003","pc":"-0.13"},{"time":"2025-04-14 10:45","o":"2.378","c":"2.384","h":"2.386","l":"2.377","v":"413862","prc":"0.006","pc":"0.25"},{"time":"2025-04-14 11:00","o":"2.384","c":"2.386","h":"2.388","l":"2.384","v":"156126","prc":"0.002","pc":"0.08"},{"time":"2025-04-14 11:15","o":"2.386","c":"2.381","h":"2.393","l":"2.381","v":"199552","prc":"-0.005","pc":"-0.21"},{"time":"2025-04-14 11:30","o":"2.381","c":"2.380","h":"2.385","l":"2.379","v":"160126","prc":"-0.001","pc":"-0.04"},{"time":"2025-04-14 13:15","o":"2.380","c":"2.371","h":"2.380","l":"2.371","v":"239596","prc":"-0.009","pc":"-0.38"},{"time":"2025-04-14 13:30","o":"2.371","c":"2.369","h":"2.373","l":"2.366","v":"205761","prc":"-0.002","pc":"-0.08"},{"time":"2025-04-14 13:45","o":"2.369","c":"2.365","h":"2.370","l":"2.364","v":"107152","prc":"-0.004","pc":"-0.17"},{"time":"2025-04-14 14:00","o":"2.365","c":"2.373","h":"2.373","l":"2.365","v":"130244","prc":"0.008","pc":"0.34"},{"time":"2025-04-14 14:15","o":"2.374","c":"2.372","h":"2.374","l":"2.367","v":"237162","prc":"-0.001","pc":"-0.04"},{"time":"2025-04-14 14:30","o":"2.372","c":"2.372","h":"2.373","l":"2.368","v":"158491","prc":"0.000","pc":"0.00"},{"time":"2025-04-14 14:45","o":"2.371","c":"2.374","h":"2.375","l":"2.369","v":"234811","prc":"0.002","pc":"0.08"},{"time":"2025-04-14 15:00","o":"2.374","c":"2.374","h":"2.376","l":"2.372","v":"547500","prc":"0.000","pc":"0.00"},{"time":"2025-04-15 09:45","o":"2.372","c":"2.353","h":"2.380","l":"2.353","v":"919191","prc":"-0.021","pc":"-0.88"},{"time":"2025-04-15 10:00","o":"2.353","c":"2.356","h":"2.363","l":"2.352","v":"305891","prc":"0.003","pc":"0.13"},{"time":"2025-04-15 10:15","o":"2.356","c":"2.359","h":"2.362","l":"2.354","v":"112932","prc":"0.003","pc":"0.13"},{"time":"2025-04-15 10:30","o":"2.359","c":"2.359","h":"2.361","l":"2.357","v":"73077","prc":"0.000","pc":"0.00"},{"time":"2025-04-15 10:45","o":"2.359","c":"2.359","h":"2.364","l":"2.358","v":"161953","prc":"0.000","pc":"0.00"},{"time":"2025-04-15 11:00","o":"2.359","c":"2.361","h":"2.362","l":"2.356","v":"85585","prc":"0.002","pc":"0.08"},{"time":"2025-04-15 11:15","o":"2.361","c":"2.360","h":"2.364","l":"2.358","v":"71363","prc":"-0.001","pc":"-0.04"},{"time":"2025-04-15 11:30","o":"2.360","c":"2.356","h":"2.361","l":"2.350","v":"135179","prc":"-0.004","pc":"-0.17"},{"time":"2025-04-15 13:15","o":"2.356","c":"2.350","h":"2.358","l":"2.349","v":"216195","prc":"-0.006","pc":"-0.25"},{"time":"2025-04-15 13:30","o":"2.350","c":"2.357","h":"2.357","l":"2.349","v":"1196804","prc":"0.007","pc":"0.30"},{"time":"2025-04-15 13:45","o":"2.357","c":"2.365","h":"2.365","l":"2.355","v":"144264","prc":"0.008","pc":"0.34"},{"time":"2025-04-15 14:00","o":"2.365","c":"2.360","h":"2.367","l":"2.359","v":"227432","prc":"-0.005","pc":"-0.21"},{"time":"2025-04-15 14:15","o":"2.360","c":"2.364","h":"2.365","l":"2.356","v":"96901","prc":"0.004","pc":"0.17"},{"time":"2025-04-15 14:30","o":"2.365","c":"2.362","h":"2.365","l":"2.361","v":"89872","prc":"-0.002","pc":"-0.08"},{"time":"2025-04-15 14:45","o":"2.363","c":"2.364","h":"2.365","l":"2.357","v":"506845","prc":"0.002","pc":"0.08"},{"time":"2025-04-15 15:00","o":"2.365","c":"2.365","h":"2.368","l":"2.361","v":"1344815","prc":"0.001","pc":"0.04"},{"time":"2025-04-16 09:45","o":"2.353","c":"2.354","h":"2.360","l":"2.346","v":"861617","prc":"-0.011","pc":"-0.47"},{"time":"2025-04-16 10:00","o":"2.354","c":"2.350","h":"2.358","l":"2.349","v":"342820","prc":"-0.004","pc":"-0.17"},{"time":"2025-04-16 10:15","o":"2.351","c":"2.346","h":"2.351","l":"2.346","v":"205932","prc":"-0.004","pc":"-0.17"},{"time":"2025-04-16 10:30","o":"2.346","c":"2.337","h":"2.346","l":"2.336","v":"245717","prc":"-0.009","pc":"-0.38"}];
        } else if (klt == 1 && code == '600800') {
          kdata = [{"time":"2025-04-18 11:14","o":"3.61","c":"3.58","h":"3.61","l":"3.57","v":"4500","prc":"-0.030","pc":"-0.83"},{"time":"2025-04-18 11:15","o":"3.58","c":"3.60","h":"3.60","l":"3.58","v":"4298","prc":"0.020","pc":"0.56"},{"time":"2025-04-18 11:16","o":"3.60","c":"3.57","h":"3.60","l":"3.57","v":"5805","prc":"-0.030","pc":"-0.83"},{"time":"2025-04-18 11:17","o":"3.57","c":"3.54","h":"3.58","l":"3.54","v":"4236","prc":"-0.030","pc":"-0.84"},{"time":"2025-04-18 11:18","o":"3.55","c":"3.56","h":"3.57","l":"3.54","v":"5663","prc":"0.020","pc":"0.56"},{"time":"2025-04-18 11:19","o":"3.56","c":"3.57","h":"3.57","l":"3.55","v":"2953","prc":"0.010","pc":"0.28"},{"time":"2025-04-18 11:20","o":"3.57","c":"3.54","h":"3.57","l":"3.53","v":"2770","prc":"-0.030","pc":"-0.84"},{"time":"2025-04-18 11:21","o":"3.54","c":"3.55","h":"3.55","l":"3.53","v":"2151","prc":"0.010","pc":"0.28"},{"time":"2025-04-18 11:22","o":"3.55","c":"3.54","h":"3.56","l":"3.51","v":"5688","prc":"-0.010","pc":"-0.28"},{"time":"2025-04-18 11:23","o":"3.54","c":"3.53","h":"3.54","l":"3.52","v":"787","prc":"-0.010","pc":"-0.28"},{"time":"2025-04-18 11:24","o":"3.53","c":"3.52","h":"3.54","l":"3.50","v":"4264","prc":"-0.010","pc":"-0.28"},{"time":"2025-04-18 11:25","o":"3.52","c":"3.54","h":"3.54","l":"3.51","v":"1431","prc":"0.020","pc":"0.57"},{"time":"2025-04-18 11:26","o":"3.54","c":"3.54","h":"3.54","l":"3.53","v":"1262","prc":"0.000","pc":"0.00"},{"time":"2025-04-18 11:27","o":"3.54","c":"3.53","h":"3.54","l":"3.53","v":"929","prc":"-0.010","pc":"-0.28"},{"time":"2025-04-18 11:28","o":"3.52","c":"3.52","h":"3.53","l":"3.50","v":"3553","prc":"-0.010","pc":"-0.28"},{"time":"2025-04-18 11:29","o":"3.52","c":"3.52","h":"3.53","l":"3.52","v":"2233","prc":"0.000","pc":"0.00"},{"time":"2025-04-18 11:30","o":"3.52","c":"3.50","h":"3.52","l":"3.50","v":"2242","prc":"-0.020","pc":"-0.57"},{"time":"2025-04-18 13:01","o":"3.51","c":"3.50","h":"3.51","l":"3.50","v":"5100","prc":"0.000","pc":"0.00"},{"time":"2025-04-18 13:02","o":"3.49","c":"3.47","h":"3.49","l":"3.47","v":"2926","prc":"-0.030","pc":"-0.86"}];
        }
        return {code, kltype: klt, kdata};
    });
    accld.enableCredit = true;
    accld.initAccounts();
  });

  afterEach(() => {
    loadWatchingsStub.restore();
    fengGetsecidStub.restore();
    getStockKlineStub.restore();
  });

  it('StrategyGE should sell', () => {
    accld.normalAccount.addWatchStock('512100', {"grptype":"GroupStandard","strategies":{"0":{"key":"StrategyGE","enabled":true,"stepRate":0.06,"account":"credit","kltype":"30","guardPrice":"2.116","inCritical":false,"selltype":"egate","cutselltype":"egate"}},"transfers":{"0":{"transfer":-1}},"buydetail":[{"count":3800,"date":"2023-06-21","price":2.651,"sid":"150663","type":"B","code":"SH512100"},{"count":7900,"date":"2024-11-15","price":2.523,"sid":"506698","type":"B","code":"SH512100"},{"count":4400,"date":"2025-04-07","price":2.281,"sid":"317515","type":"B","code":"SH512100"},{"count":9500,"date":"2025-04-09","price":2.116,"sid":"114907","type":"B","code":"SH512100"}],"buydetail_full":[{"count":3800,"date":"2023-06-21","price":2.651,"sid":"150663","type":"B","code":"SH512100"},{"count":7900,"date":"2024-11-15","price":2.523,"sid":"506698","type":"B","code":"SH512100"},{"count":4400,"date":"2025-04-07","price":2.281,"sid":"317515","type":"B","code":"SH512100"},{"count":9500,"date":"2025-04-09","price":2.119,"sid":"114907","type":"B","code":"SH512100"}],"amount":10000});
    alarmHub.setupAlarms();
    alarmHub.klineAlarms.hitCount = 15;
    alarmHub.klineAlarms.onTimer();
    console.log(klPad.klines);
  });

  it('StrategySellELS should sell', () => {
    accld.collateralAccount.addWatchStock('600800', {"grptype":"GroupStandard","strategies":{"0":{"key":"StrategySellELS","enabled":true,"cutselltype":"all","selltype":"all","guardPrice":"3.50"}},"transfers":{"0":{"transfer":-1}},
      "buydetail": [{"code":"SH600800","date":"2025-04-17","count":2400,"price":2.97,"sid":"29316","type":"B"}],
      "buydetail_full":[{"count":2400,"date":"2025-04-17","price":2.97,"sid":"29316","type":"B","code":"SH600800"}],"count0":2400,"amount":7000})
    alarmHub.setupAlarms();
    alarmHub.klineAlarms.onTimer();
  });
});

